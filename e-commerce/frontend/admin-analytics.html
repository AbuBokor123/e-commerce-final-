<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics - ShoeHub Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="admin-container">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="sidebar-header">
          <img src="images/logo-main.png" alt="Logo" class="logo">
        </div>
        <nav class="sidebar-nav">
          <div class="nav-section">
            <h3>MAIN MENU</h3>
            <ul>
              <li>
                <a href="admin.html">
                  <i class="fas fa-th-large"></i>
                  Dashboard
                </a>
              </li>
              <li>
                <a href="admin-products.html">
                  <i class="fas fa-box"></i>
                  Products
                  <span class="badge">+28</span>
                </a>
              </li>
              <li>
                <a href="admin-orders.html">
                  <i class="fas fa-box"></i>
                  Orders
                  <span class="badge">+28</span>
                </a>
              </li>
              <li class="active">
                <a href="admin-analytics.html">
                  <i class="fas fa-chart-line"></i>
                  Analytics
                </a>
              </li>
            
              <li>
                <!-- <a href="admin-revenue.html">
                  <i class="fas fa-dollar-sign"></i>
                  Revenue
                </a> -->
             
              </li>
              <li class="has-submenu" id="admin-submenu">
                <button class="submenu-btn">
                  <span>
                    <i class="fas fa-users"></i>
                    Users
                  </span>
                  <i class="fas fa-chevron-down submenu-toggle"></i>
                </button>
                <ul class="submenu">
                  <li>
                    <a href="admin-customers.html">
                      <i class="fas fa-user"></i>
                      Customers
                    </a>
                  </li>
                  <li>
                    <a href="admin-admins.html">
                      <i class="fas fa-user-shield"></i>
                      Admins
                    </a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="#logout">
                  <i class="fas fa-sign-out-alt"></i>
                  Logout
                </a>
              </li>
            </ul>
          </div>

          <div class="nav-section">
            <h3>APPS</h3>
            <ul>
              <li>
                <a href="admin-email.html">
                  <i class="fas fa-envelope"></i>
                  Email
                </a>
              </li>
              <li>
                <a href="admin-chat.html">
                  <i class="fas fa-comments"></i>
                  Chat
                </a>
              </li>
            </ul>
          </div>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="admin-main">
        <header class="admin-header">
          <div class="header-left">
            <button id="sidebar-toggle">
              <i class="fas fa-bars"></i>
            </button>
            <div class="search-bar">
              <i class="fas fa-search"></i>
              <input type="search" placeholder="Search..." />
            </div>
          </div>
          <div class="header-right">
            <div class="header-actions">
              <button class="action-btn">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">5</span>
              </button>
              <button class="action-btn">
                <i class="fas fa-envelope"></i>
                <span class="notification-badge">3</span>
              </button>
            </div>
            <div class="admin-profile">
              <img src="images/adminicon.png" alt="Admin Avatar" />
              <span id="adminName">Admin</span>
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
        </header>

        <div class="admin-content">
          <div class="content-header">
            <h1>Analytics Dashboard</h1>
            <div class="date-filter">
              <select>
                <option>Last 7 Days</option>
                <option>Last 30 Days</option>
                <option>Last 90 Days</option>
                <option>Custom Range</option>
              </select>
            </div>
          </div>

          <!-- Analytics Charts -->
          <div class="analytics-grid">
            <div class="chart-card">
              <!-- <h3>Sales Overview</h3>
              <canvas id="salesChart"></canvas>
              <canvas id="salesPieChart"></canvas>
            </div>
            <div class="chart-card">
              <h3>Revenue by Category</h3>
              <canvas id="categoryChart"></canvas>
              <canvas id="categoryPieChart"></canvas>
            </div>
            <div class="chart-card">
              <h3>Customer Growth</h3>
              <canvas id="customerChart"></canvas>
              <canvas id="customerPieChart"></canvas>
            </div>
            <div class="chart-card">
              <h3>Top Products</h3>
              <canvas id="productsChart"></canvas>
              <canvas id="productsPieChart"></canvas>
            </div> -->
            <div class="chart-card">
              <h3>Business Analytics</h3>
              <canvas id="codeChart"></canvas>
              <canvas id="codePieChart"></canvas>
            </div>
          </div>

          <!-- Analytics Stats -->
          <div class="analytics-stats" id="analyticsStats">
            <!-- Stats will be loaded dynamically -->
          </div>
        </div>
      </main>
    </div>

    <script src="admin.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Display user name like admin-products
        const adminNameElement = document.getElementById('adminName');
        const userName = localStorage.getItem('user_name');
        if (adminNameElement && userName) {
          adminNameElement.textContent = userName;
        } else {
          // Fallback: fetch from backend if not in localStorage
          const token = localStorage.getItem('access_token');
          if (token) {
            fetch('http://localhost:8000/api/auth/login/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token })
            })
            .then(res => res.json())
            .then(data => {
              if (data.username) {
                adminNameElement.textContent = data.username;
                localStorage.setItem('user_name', data.username);
              }
            });
          }
        }
        // ...existing code...
        const filterSelect = document.querySelector(".date-filter select");
        let filterValue = "7";
        if (filterSelect) {
          filterSelect.addEventListener("change", function () {
            const val = this.value;
            if (val.includes("7")) filterValue = "7";
            else if (val.includes("30")) filterValue = "30";
            else if (val.includes("90")) filterValue = "90";
            else filterValue = "custom";
            loadAnalytics(filterValue);
          });
        }
        loadAnalytics(filterValue);
        async function loadAnalytics(days) {
          // Business Analytics
          const token = localStorage.getItem('access_token');
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
          let res = await fetch(`http://localhost:8000/api/code-analytics/?days=${days}`, { headers });
          let data = await res.json();
          // Top Sales Charts
          renderChart('codeChart', 'bar', data.labels, data.data, 'Top Sales');
          renderChart('codePieChart', 'pie', data.labels, data.data, 'Top Sales');
          // Business Stats
          renderStats({
            total_sales: data.total_sales,
            total_revenue: data.total_revenue
          });
        }
        // Store chart instances to allow proper re-rendering
        const chartInstances = {};
        function renderChart(id, type, labels, data, label) {
          // Destroy previous chart instance if exists
          if (chartInstances[id]) {
            chartInstances[id].destroy();
          }
          const ctx = document.getElementById(id).getContext('2d');
          chartInstances[id] = new Chart(ctx, {
            type: type,
            data: {
              labels: labels,
              datasets: [{
                label: label,
                data: data,
                backgroundColor: type === 'pie' ? [
                  '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#6610f2', '#e83e8c'
                ] : '#007bff',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: type === 'pie' },
                title: { display: true, text: label }
              }
            }
          });
        }
        function renderStats(stats) {
          const statsDiv = document.getElementById('analyticsStats');
          statsDiv.innerHTML = `
            <div style="display:flex;gap:32px;justify-content:center;align-items:center;">
              <div style="background:#f5f5f5;padding:24px 32px;border-radius:12px;min-width:220px;text-align:center;">
                <h2 style="margin-bottom:8px;font-size:2.2rem;color:#007bff;">${stats.total_sales ?? 0}</h2>
                <div style="font-size:1.1rem;color:#333;">Total Sales</div>
              </div>
              <div style="background:#f5f5f5;padding:24px 32px;border-radius:12px;min-width:220px;text-align:center;">
                <h2 style="margin-bottom:8px;font-size:2.2rem;color:#28a745;">$${stats.total_revenue?.toLocaleString() ?? '0'}</h2>
                <div style="font-size:1.1rem;color:#333;">Total Revenue</div>
              </div>
            </div>
          `;
        }
        // ...existing code...
      });
    </script>
  </body>
</html> 